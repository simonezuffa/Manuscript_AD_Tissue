Sys.getenv("CC")
Sys.setenv(CC = "/opt/homebrew/bin/gfortran")
> Sys.getenv("CC")
Sys.setenv(CC = "/opt/homebrew/bin/gfortran")
Sys.getenv("CC")
devtools::install_github("pmartR/pmartR@*release")
devtools::install_github("ricoderks/Rcpm")
library(pacman)
pacman::p_load(c("impute", "pcaMethods", "globaltest", "GlobalAncova", "Rgraphviz", "preprocessCore", "genefilter", "sva", "limma", "KEGGgraph", "siggenes","BiocParallel", "MSnbase", "multtest","RBGL","edgeR","fgsea","httr","qs"))
devtools::install_github("xia-lab/MetaboAnalystR", build = TRUE, build_vignettes = TRUE, build_manual =T)
BiocManager::install("RBGL")
BiocManager::install("fgsea")
BiocManager::install("siggenes")
devtools::install_github("xia-lab/MetaboAnalystR", build = TRUE, build_vignettes = TRUE, build_manual =T)
install.packages(c("bslib", "cluster", "crosstalk", "deldir", "diptest", "dplyr", "GGally", "gtools", "htmlwidgets", "insight", "interp", "jqr", "Matrix", "MatrixModels", "mclust", "mvtnorm", "nlme", "pls", "PMCMRplus", "R.utils", "Rfast", "shiny", "sodium", "sp", "stringi", "stringr", "tinytex"))
install.packages(c("bslib", "Cairo", "cluster", "deSolve", "expm", "foreign", "gmp", "interp", "mvtnorm", "ncdf4", "nlme", "qs", "rgl", "robustbase", "Rserve", "scales", "stringfish", "units", "wk", "XML"))
install.packages(c("checkmate", "cluster", "cpp11", "gert", "jqr", "jsonlite", "RcppArmadillo", "Rmpfr", "testthat", "vctrs", "xml2"))
install.packages(c("gert", "jqr", "Rmpfr"))
sixmix_fix_feature_info
install.packages("omicsTools")
devtools::install_github("pmartR/pmartR@*release")
install.packages(c("brew", "brio", "cli", "cowplot", "curl", "data.table", "datawizard", "DBI", "desc", "DiceDesign", "DT", "e1071", "emmeans", "fansi", "filelock", "future", "future.apply", "gdtools", "ggeffects", "ggside", "htmlwidgets", "httpuv", "igraph", "later", "maps", "markdown", "matrixStats", "mgcv", "pcaPP", "pkgbuild", "PMCMRplus", "processx", "progress", "qs", "ragg", "rayimage", "rayrender", "rayvertex", "recipes", "rnaturalearth", "rpart", "RSQLite", "Rtsne", "s2", "sass", "sf", "stringi", "svglite", "tensorA", "terra", "tidygraph", "timeDate", "vipor", "vroom", "xgboost", "yaml", "zCompositions"))
install.packages(c("brew", "brio", "cli", "cowplot", "curl", "data.table", "datawizard", "DBI", "desc", "DiceDesign", "DT", "e1071", "emmeans", "fansi", "filelock", "future", "future.apply", "gdtools", "ggeffects", "ggside", "htmlwidgets", "httpuv", "igraph", "later", "maps", "markdown", "matrixStats", "mgcv", "pcaPP", "pkgbuild", "PMCMRplus", "processx", "progress", "qs", "ragg", "rayimage", "rayrender", "rayvertex", "recipes", "rnaturalearth", "rpart", "RSQLite", "Rtsne", "s2", "sass", "sf", "stringi", "svglite", "tensorA", "terra", "tidygraph", "timeDate", "vipor", "vroom", "xgboost", "yaml", "zCompositions"))
install.packages(c("brew", "brio", "cli", "cowplot", "curl", "data.table", "datawizard", "DBI", "desc", "DiceDesign", "DT", "e1071", "emmeans", "fansi", "filelock", "future", "future.apply", "gdtools", "ggeffects", "ggside", "htmlwidgets", "httpuv", "igraph", "later", "maps", "markdown", "matrixStats", "mgcv", "pcaPP", "pkgbuild", "PMCMRplus", "processx", "progress", "qs", "ragg", "rayimage", "rayrender", "rayvertex", "recipes", "rnaturalearth", "rpart", "RSQLite", "Rtsne", "s2", "sass", "sf", "stringi", "svglite", "tensorA", "terra", "tidygraph", "timeDate", "vipor", "vroom", "xgboost", "yaml", "zCompositions"))
install.packages(c("brew", "brio", "cli", "cowplot", "curl", "data.table", "datawizard", "DBI", "desc", "DiceDesign", "DT", "e1071", "emmeans", "fansi", "filelock", "future", "future.apply", "gdtools", "ggeffects", "ggside", "htmlwidgets", "httpuv", "igraph", "later", "maps", "markdown", "matrixStats", "mgcv", "pcaPP", "pkgbuild", "PMCMRplus", "processx", "progress", "qs", "ragg", "rayimage", "rayrender", "rayvertex", "recipes", "rnaturalearth", "rpart", "RSQLite", "Rtsne", "s2", "sass", "sf", "stringi", "svglite", "tensorA", "terra", "tidygraph", "timeDate", "vipor", "vroom", "xgboost", "yaml", "zCompositions"))
install.packages(c("castor", "compositions", "patchwork", "phytools", "Rcpp", "RCurl", "zCompositions"))
install.packages("compositions")
install.packages(c("BH", "compositions", "DBI", "digest", "expm", "gbm", "ggrepel", "ggstatsplot", "glue", "gmp", "graphlayouts", "MASS", "Matrix", "pkgload", "plotly", "ps", "readr", "reprex", "rlang", "roxygen2", "statsExpressions", "timechange", "uuid", "withr", "yardstick"))
install.packages(c("BayesFactor", "bs4Dash", "cowplot", "emmeans", "hoardr", "MALDIquant", "R.oo", "roxygen2", "tidyr"))
remotes::install_github("kevinmildau/homologueDiscoverer")
install.packages("MassTools")
remotes::install_github("tidymass/masstools")
remotes::install_github("kevinmildau/homologueDiscoverer")
remotes::install_github("mjhelf/MassTools")
remotes::install_github("kevinmildau/homologueDiscoverer")
install.packages("xgboost")
install.packages(c("gdtools", "ggplot2", "mclust", "shape"))
install.packages(c("afex", "bookdown", "boot", "curl", "data.table", "deldir", "gdtools", "ggeffects", "ggraph", "ggsci", "ggside", "hrbrthemes", "lava", "locfit", "officer", "parallelly", "prettymapr", "RcppArmadillo", "RcppEigen", "renv", "rgl", "rmarkdown", "tweenr"))
install.packages(c("ggraph", "santaR", "systemfonts"))
install.packages(c("digest", "globals", "graphlayouts", "multcompView", "qs", "tidyselect", "zCompositions"))
install.packages(c("ggsci", "Hmisc", "igraph", "insight", "parameters", "pkgbuild", "processx", "ragg", "remotes", "sass", "tinytex", "WRS2", "zCompositions"))
install.packages(c("broom.helpers", "broom.mixed", "bslib", "codetools", "data.table", "datawizard", "DT", "effectsize", "future", "future.apply", "ggeffects", "ggstats", "gh", "htmltools", "httpuv", "httr2", "infer", "lme4", "munsell", "promises", "RcppArmadillo", "RSQLite", "shiny", "tidymodels", "WikipediR"))
install.packages(c("emmeans", "ggstatsplot", "knitr", "RcppArmadillo"))
install.packages(c("lme4", "RcppArmadillo"))
install.packages(c("ggfortify", "ggplot2", "gtable", "labelled", "openssl", "pkgdown", "survival", "tune"))
install.packages(c("brio", "fs", "xopen"))
install.packages(c("mclust", "pixmap", "sp"))
install.packages(c("BiocManager", "officer", "ragg", "RcppArmadillo", "stringi", "tinytex"))
install.packages(c("backports", "broom", "cachem", "effectsize", "emmeans", "estimability", "farver", "fastmap", "ggeffects", "ggsci", "highr", "Hmisc", "insight", "KernSmooth", "minqa", "mvtnorm", "openssl", "parameters", "qs", "quantreg", "ragg", "RApiSerialize", "RcppArmadillo", "rmarkdown", "RSQLite", "sjmisc", "sjPlot", "sjstats", "spacefillr", "SparseM", "systemfonts", "terra", "textshaping", "vegan", "xfun"))
install.packages(c("Hmisc", "qs"))
install.packages(c("DBI", "hardhat", "Hmisc", "qs", "RcppArmadillo", "SparseM"))
install.packages(c("correlation", "datawizard", "downlit", "evaluate", "Hmisc", "insight", "markdown", "mc2d", "nlme", "performance", "phytools", "qs", "RcppArmadillo", "rlang", "SparseM", "survival", "waveslim"))
install.packages(c("nlme", "nloptr", "qs", "RcppArmadillo", "robustbase", "SparseM"))
install.packages(c("bookdown", "effectsize", "lme4", "nlme", "nloptr", "ps", "qs", "RcppArmadillo", "recipes", "robustbase", "SparseM", "statsExpressions", "yaml"))
install.packages(c("nlme", "nloptr", "qs", "RcppArmadillo", "robustbase", "SparseM"))
install.packages(c("ggstatsplot", "knitr", "nlme", "nloptr", "pkgdown", "qs", "RcppArmadillo", "RcppParallel", "reprex", "robustbase", "SparseM"))
install.packages(c("nlme", "nloptr", "qs", "RcppArmadillo", "robustbase", "SparseM", "wk"))
install.packages(c("cubature", "datawizard", "httr2", "insight", "nlme", "nloptr", "performance", "qs", "rayimage", "Rcpp", "RcppArmadillo", "robustbase", "s2", "SparseM"))
install.packages(c("clock", "ipred", "nlme", "nloptr", "performance", "qs", "RcppArmadillo", "robustbase", "RSpectra", "s2", "SparseM", "tinytex", "xfun"))
install.packages(c("crul", "datawizard", "gert", "htmlTable", "nlme", "nloptr", "parameters", "qs", "rayvertex", "RcppArmadillo", "robustbase", "RSpectra", "s2", "SparseM"))
install.packages(c("bayestestR", "colorspace", "gert", "nlme", "nloptr", "polyclip", "qs", "RcppArmadillo", "robustbase", "RSpectra", "s2", "SparseM", "xgboost", "yaml"))
install.packages(c("bitops", "bslib", "checkmate", "future", "gert", "nlme", "nloptr", "parallelly", "qs", "rayrender", "RcppArmadillo", "robustbase", "RSpectra", "s2", "SparseM", "usethis", "uuid"))
install.packages(c("dials", "gert", "nlme", "nloptr", "pls", "qs", "rayrender", "RcppArmadillo", "robustbase", "RSpectra", "s2", "shiny", "SparseM", "withr"))
install.packages(c("gert", "nlme", "nloptr", "qs", "RcppArmadillo", "robustbase", "RSpectra", "s2", "SparseM"))
install.packages(c("gert", "nlme", "nloptr", "pcaPP", "qs", "RcppArmadillo", "robustbase", "RSpectra", "s2", "SparseM"))
install.packages(c("corrplot", "digest", "expm", "fastDummies", "fBasics", "gert", "golem", "insight", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "qs", "RcppArmadillo", "RcppEigen", "rmarkdown", "robustbase", "rrcov", "RSpectra", "s2", "SparseM", "stabledist", "xfun"))
install.packages(c("BiocManager", "boot", "broom.helpers", "cpp11", "curl", "data.table", "emmeans", "EnvStats", "expm", "fBasics", "gdtools", "gert", "gmp", "golem", "httr2", "jqr", "jtools", "MALDIquant", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "qs", "RANN", "RcppArmadillo", "RcppEigen", "RcppParallel", "robustbase", "rrcov", "RSpectra", "s2", "shapviz", "SparseM", "taxize", "vegan", "waldo"))
install.packages(c("expm", "fBasics", "gdtools", "gert", "gmp", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "qs", "RcppArmadillo", "RcppEigen", "robustbase", "rrcov", "RSpectra", "s2", "SparseM", "vegan"))
install.packages(c("afex", "bs4Dash", "cards", "datawizard", "expm", "fBasics", "gdtools", "gert", "ggeffects", "gmp", "insight", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "performance", "qs", "RcppArmadillo", "RcppEigen", "robustbase", "rrcov", "RSpectra", "s2", "SparseM", "SuppDists", "vegan"))
install.packages(c("abind", "bit", "bit64", "bitops", "broom", "car", "cards", "caTools", "curl", "Deriv", "e1071", "evaluate", "expm", "fBasics", "gdtools", "gert", "ggrepel", "ggstats", "glue", "gmp", "graphlayouts", "hexbin", "httr2", "insight", "jqr", "jsonlite", "matrixStats", "microbenchmark", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "parameters", "patchwork", "pcaPP", "phangorn", "pkgdown", "pls", "PMCMRplus", "profvis", "ps", "qs", "ragg", "randomForest", "RApiSerialize", "raster", "RcppArmadillo", "RcppEigen", "renv", "reticulate", "rjson", "robustbase", "rrcov", "RSpectra", "rsvg", "s2", "sandwich", "sf", "shapviz", "SparseM", "statsExpressions", "timeDate", "timeSeries", "tinytex", "vegan", "wk", "xfun"))
install.packages(c("askpass", "commonmark", "credentials", "expm", "fBasics", "gdtools", "gert", "gmp", "hexbin", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "phangorn", "PMCMRplus", "qs", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "robustbase", "rrcov", "RSpectra", "rsvg", "s2", "sf", "sodium", "SparseM", "sys", "vegan"))
install.packages(c("datawizard", "expm", "fBasics", "gdtools", "gert", "gmp", "gplots", "hexbin", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "phangorn", "PMCMRplus", "qs", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "renv", "robustbase", "rrcov", "RSpectra", "rsvg", "s2", "sf", "sodium", "SparseM", "vegan"))
install.packages(c("bayestestR", "bookdown", "broom.mixed", "corrplot", "data.table", "doBy", "emmeans", "evaluate", "expm", "fBasics", "gdtools", "gert", "ggeffects", "gmp", "gss", "hexbin", "jqr", "minqa", "modelenv", "mvtnorm", "ncdf4", "nlme", "nloptr", "officer", "openssl", "parameters", "pcaPP", "performance", "phangorn", "PMCMRplus", "qs", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "renv", "robustbase", "rrcov", "RSpectra", "rstudioapi", "rsvg", "s2", "sf", "shapviz", "sodium", "SparseM", "terra", "vegan", "wk"))
# Load required libraries
library(tidymodels)
library(tidyverse)
library(ranger)
library(vip)
library(SHAPforxgboost)
# Set seed for reproducibility
set.seed(42)
# Function to create train-test split and preprocessing
create_splits <- function(data, target_col, split_prop = 0.8) {
# Create the initial split
initial_split <- initial_split(data, prop = split_prop, strata = !!sym(target_col))
# Create the training and testing sets
train_data <- training(initial_split)
test_data <- testing(initial_split)
# Create cross-validation folds
cv_folds <- vfold_cv(train_data, v = 5, strata = !!sym(target_col))
# Create the recipe
model_recipe <- recipe(formula = as.formula(paste(target_col, "~ .")),
data = train_data) %>%
step_normalize(all_predictors()) %>%
step_zv(all_predictors())
return(list(
train_data = train_data,
test_data = test_data,
cv_folds = cv_folds,
recipe = model_recipe
))
}
# Function to define model specification and workflow
create_rf_workflow <- function() {
# Define the model specification
rf_spec <- rand_forest(
mtry = tune(),
trees = tune(),
min_n = tune()
) %>%
set_engine("ranger", importance = "permutation") %>%
set_mode("classification")
# Create the workflow
rf_workflow <- workflow() %>%
add_model(rf_spec)
return(rf_workflow)
}
# Function to perform hyperparameter tuning
tune_rf_model <- function(workflow, recipe, cv_folds) {
# Define the parameter grid
rf_grid <- grid_random(
mtry() %>% range_set(c(3, 8)),
trees() %>% range_set(c(100, 1000)),
min_n() %>% range_set(c(2, 10)),
size = 30
)
# Add recipe to workflow
workflow <- workflow %>%
add_recipe(recipe)
# Tune the model
rf_tuning <- workflow %>%
tune_grid(
resamples = cv_folds,
grid = rf_grid,
metrics = metric_set(accuracy, roc_auc, precision, recall),
control = control_grid(save_pred = TRUE)
)
return(rf_tuning)
}
# Function to analyze tuning results
analyze_tuning_results <- function(tuning_results) {
# Show best results
best_results <- tuning_results %>%
show_best(metric = "accuracy", n = 5)
print("Top 5 models by accuracy:")
print(best_results)
# Create visualization of parameter impact
tuning_results %>%
collect_metrics() %>%
filter(.metric == "accuracy") %>%
select(mean, mtry, trees, min_n) %>%
pivot_longer(cols = c(mtry, trees, min_n),
names_to = "parameter",
values_to = "value") %>%
ggplot(aes(value, mean)) +
geom_point(alpha = 0.5) +
facet_wrap(~parameter, scales = "free_x") +
labs(x = "Parameter Value", y = "Mean Accuracy") +
theme_bw()
return(best_results)
}
# Function to finalize model with best parameters
finalize_model <- function(workflow, tuning_results, train_data) {
# Get best parameters
best_params <- tuning_results %>%
select_best(metric = "accuracy")
# Finalize workflow
final_workflow <- workflow %>%
finalize_workflow(best_params)
# Fit the final model
final_model <- final_workflow %>%
fit(data = train_data)
return(final_model)
}
# Function to evaluate model performance
evaluate_model <- function(final_model, test_data, target_col) {
# Make predictions
predictions <- predict(final_model, test_data) %>%
bind_cols(test_data)
# Calculate metrics
metrics <- predictions %>%
metrics(truth = !!sym(target_col), estimate = .pred_class)
# Create confusion matrix
conf_mat <- predictions %>%
conf_mat(truth = !!sym(target_col), estimate = .pred_class)
# Plot confusion matrix
conf_mat %>%
autoplot(type = "heatmap")
return(list(
metrics = metrics,
conf_mat = conf_mat
))
}
# Function to analyze feature importance
analyze_feature_importance <- function(final_model, train_data) {
# Extract feature importance
importance <- final_model %>%
extract_fit_parsnip() %>%
vip(num_features = 20)
# Plot feature importance
print(importance)
# Calculate SHAP values (if possible with the data)
# Note: This requires the data to be in the correct format
tryCatch({
model_fit <- final_model %>%
extract_fit_engine()
# Prepare data for SHAP calculation
pred_data <- train_data %>%
select(-target) %>%
as.matrix()
shap_values <- ranger.unify(model_fit, pred_data)
# Plot SHAP summary
shap.plot.summary(shap_values)
}, error = function(e) {
message("Could not calculate SHAP values. This might be due to data format issues.")
})
return(importance)
}
# Main execution function
run_rf_analysis <- function(data, target_col) {
# Split data and create recipe
splits <- create_splits(data, target_col)
# Create workflow
rf_workflow <- create_rf_workflow()
# Tune model
tuning_results <- tune_rf_model(rf_workflow, splits$recipe, splits$cv_folds)
# Analyze tuning results
best_results <- analyze_tuning_results(tuning_results)
# Finalize model
final_model <- finalize_model(rf_workflow, tuning_results, splits$train_data)
# Evaluate model
evaluation <- evaluate_model(final_model, splits$test_data, target_col)
# Analyze feature importance
importance <- analyze_feature_importance(final_model, splits$train_data)
return(list(
model = final_model,
evaluation = evaluation,
importance = importance,
tuning_results = tuning_results
))
}
# Example with built-in dataset
data(iris)
results <- run_rf_analysis(iris, "Species")
install.packages(c("correlation", "expm", "fBasics", "fs", "future.apply", "gdata", "gdtools", "gert", "ggstatsplot", "gmp", "googlePolylines", "gss", "gtable", "hexbin", "Hmisc", "httr2", "igraph", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "pcaPP", "phangorn", "pkgbuild", "PMCMRplus", "progressr", "ps", "qs", "quantreg", "R.oo", "ragg", "randomForest", "Rcpp", "RcppArmadillo", "RcppEigen", "rgl", "rmarkdown", "robustbase", "rrcov", "RSpectra", "rstudioapi", "rsvg", "sf", "slider", "sodium", "SparseM", "statsExpressions", "terra", "tinytex", "vdiffr", "vegan", "waldo", "withr", "xfun"))
install.packages(c("castor", "clue", "curl", "expm", "fBasics", "fontawesome", "gdtools", "gert", "gmp", "graphlayouts", "gss", "hexbin", "Hmisc", "igraph", "inline", "jqr", "knitr", "maps", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "parallelly", "pcaPP", "phangorn", "PMCMRplus", "qs", "quantreg", "ragg", "randomForest", "ranger", "RcppArmadillo", "RcppEigen", "reticulate", "rgl", "Rmpfr", "robustbase", "rrcov", "RSpectra", "RSQLite", "rsvg", "sf", "sodium", "SparseM", "terra", "vdiffr", "vegan", "waldo"))
install.packages(c("DEoptimR", "expm", "fBasics", "gdtools", "gert", "gmp", "gss", "hexbin", "Hmisc", "igraph", "insight", "jqr", "later", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "pcaPP", "phangorn", "PMCMRplus", "progressr", "promises", "qs", "quantreg", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "Rmpfr", "robustbase", "rrcov", "RSpectra", "rsvg", "sf", "sodium", "SparseM", "terra", "usethis", "vdiffr", "vegan"))
install.packages(c("bit", "cards", "expm", "fBasics", "gdtools", "gert", "ggeffects", "gmp", "gss", "hexbin", "Hmisc", "httr2", "igraph", "jqr", "later", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "parallelly", "parameters", "pcaPP", "phangorn", "PMCMRplus", "promises", "qs", "quantreg", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "Rmpfr", "robustbase", "rrcov", "RSpectra", "RSQLite", "rsvg", "sf", "sjPlot", "sodium", "SparseM", "terra", "vdiffr", "vegan"))
install.packages(c("caret", "cluster", "cpp11", "data.table", "effectsize", "emmeans", "expm", "fBasics", "gdtools", "gert", "gmp", "gss", "hexbin", "Hmisc", "igraph", "jqr", "lubridate", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "np", "parallelly", "pcaPP", "phangorn", "PMCMRplus", "qs", "quantreg", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "Rmpfr", "robustbase", "rrcov", "RSpectra", "rsvg", "sf", "sodium", "SparseM", "terra", "testthat", "textshaping", "vdiffr", "vegan"))
install.packages(c("ape", "BH", "expm", "fBasics", "gdtools", "gert", "gmp", "gower", "gss", "hexbin", "Hmisc", "igraph", "jqr", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "openssl", "pcaPP", "phangorn", "pillar", "PMCMRplus", "qs", "quantreg", "ragg", "randomForest", "RcppArmadillo", "RcppEigen", "Rmpfr", "robustbase", "rrcov", "Rserve", "RSpectra", "rsvg", "sf", "shiny", "sodium", "SparseM", "survival", "terra", "textshaping", "vdiffr", "vegan"))
install.packages(c("ape", "bayestestR", "bit64", "bookdown", "broom.helpers", "class", "classInt", "clock", "curl", "datawizard", "dbscan", "doRNG", "evaluate", "expm", "fastDummies", "fastmatch", "fBasics", "foreign", "gdtools", "gert", "ggeffects", "ggstats", "gmp", "graphlayouts", "gss", "hexbin", "Hmisc", "hoardr", "httr2", "igraph", "inline", "insight", "janitor", "jqr", "KernSmooth", "labelled", "lava", "lme4", "matrixStats", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "nnet", "openssl", "parallelly", "parameters", "pcaPP", "performance", "phangorn", "phytools", "pillar", "pkgbuild", "PMCMRplus", "processx", "qs", "quantreg", "ragg", "randomForest", "raster", "Rcpp", "RcppArmadillo", "RcppEigen", "RcppParallel", "RcppThread", "Rfast", "rgl", "rlang", "Rmpfr", "robustbase", "rpart", "rrcov", "RSpectra", "rsvg", "sf", "shapviz", "sodium", "SparseM", "spatial", "systemfonts", "terra", "testthat", "textshaping", "vdiffr", "vegan", "xfun", "XML", "yardstick"))
install.packages("DescTools")
install.packages("DescTools")
install.packages(c("ape", "classInt", "expm", "fBasics", "gdtools", "gert", "ggeffects", "gmp", "gss", "hexbin", "Hmisc", "igraph", "insight", "jqr", "KernSmooth", "minqa", "mvtnorm", "ncdf4", "nlme", "nloptr", "pcaPP", "phangorn", "PMCMRplus", "purrr", "qs", "quantreg", "ragg", "randomForest", "raster", "RcppArmadillo", "RcppEigen", "Rfast", "Rmpfr", "robustbase", "rrcov", "RSpectra", "rsvg", "sessioninfo", "sf", "sodium", "SparseM", "systemfonts", "terra", "textshaping", "vdiffr", "vegan"))
setwd("~/OneDrive - University of California, San Diego Health/Projects/Caltech/Data/microbiome")
library(tidyverse)
library(ggpubr)
phylorpca <- read.delim("table/plotphyloRPCA_ordination_reformat.txt")
setwd("~/OneDrive - University of California, San Diego Health/Projects/Caltech/Data/microbiome")
library(tidyverse)
library(ggpubr)
phylorpca <- read.delim("table/plotphyloRPCA_ordination_reformat.txt")
phylorpca <- read.delim("table_plot/phyloRPCA_ordination_reformat.txt")
View(phylorpca)
phylorpca <- read.delim("table_plot/RPCA_ordination_reformat.txt")
View(phylorpca)
setwd("~/OneDrive - University of California, San Diego Health/Projects/Caltech/Data/sample_fecal_3xtg_spf")
library(tidyverse)
library(mixOmics)
library(ggpubr)
library(vegan)
library(caret)
library(limma)
library(patchwork)
library(rstatix)
library(Spectra)
library(MsBackendMgf)
library(UpSetR)
library(effsize)
# Read in data
feature_table <- read_csv("gnps_quant_3xtg_spf.csv")
metadata <- read_csv("meta_3xtg_spf.csv") # there is a duplicated id 363192977 --> remove it
sample_order <- read.csv("sequence_3xtg_spf.csv")
annotations <- read.delim("fbmn_gnps2/nf_output/library/merged_results_with_gnps.tsv") %>%
dplyr::filter(!str_detect(pattern = "REFRAME", LibraryName)) # remove drug library
annotations$X.Scan. <- as.character(annotations$X.Scan.)
canopus <- read_tsv("canopus_3xtg_spf.tsv") %>% dplyr::select(1,3,5,7,9)
canopus$id <- gsub("^.*sirius_", "", canopus$id)
sample_order$Plate <- gsub("^(.*?):.*", "\\1", sample_order$Position)
info_feature <- feature_table %>% dplyr::select(1:3,7)
colnames(info_feature) <- c("Feature", "mz", "RT", "Corr_ID")
info_feature$Feature <- as.character(info_feature$Feature)
info_feature_complete <- info_feature %>%
left_join(annotations, by = c("Feature" = "X.Scan.")) %>%
dplyr::select(1:5,18,24) %>%
left_join(canopus %>% distinct(id, .keep_all = TRUE), by = c("Feature" = "id"))
# New bile acids
ba_ipsita <- read_csv("merged_Bile_acid_classic_networking.csv") %>%
dplyr::filter(SpectrumID %in% annotations$SpectrumID)
ba_rev <- read_tsv("candidate_BA_with_best_annotations.tsv") %>%
dplyr::filter(query_id %in% annotations$SpectrumID)
# Data table
data <- feature_table %>%
column_to_rownames("row ID") %>% dplyr::select(contains("Peak")) %>%
t() %>% as.data.frame() %>% rownames_to_column("SampleID") %>%
arrange(SampleID) %>% distinct(SampleID, .keep_all = TRUE) %>%
dplyr::filter(!(str_detect(pattern = "IS_in|IS_fi", SampleID))) %>%
dplyr::filter(!(str_detect(pattern = "363192977|363130503|363131277|363131285|363192967", SampleID)))
data$SampleID <- gsub(".mzML Peak area", "", data$SampleID)
# Metadata
metadata_metabolomics <- data.frame(SampleID = data$SampleID) %>%
left_join(metadata, by = c("SampleID" = "tube_id")) %>%
dplyr::select(1, 2:5, 16, 17, 19, 27, 37, 38) %>%
left_join(sample_order %>% dplyr::select(-`Sample.Type`)) %>%
dplyr::filter(!(SampleID %in% c("363192977", "363130503", "363131277", #remove duplicate and sample with no metadata
"363131285", "363192967")))
# Investigate total peak area
data_TIC <- data.frame(TIC = rowSums(data %>% column_to_rownames("SampleID"))) %>%
rownames_to_column("SampleID") %>% left_join(metadata_metabolomics)
data_TIC %>% dplyr::filter(genotype %in% c("3XTG", "B6")) %>%
ggscatter("Run_Order", "TIC", add = "reg.line") + ylim(0, 1.8e9) +
stat_cor()
# Check sample type
sample_tic <- data_TIC %>% dplyr::filter(str_detect(pattern = "36", SampleID)) %>% summarise(mean(TIC))
pool_tic <- data_TIC %>% dplyr::filter(str_detect(pattern = "Pool", SampleID)) %>% summarise(mean(TIC))
six_tic <- data_TIC %>% dplyr::filter(str_detect(pattern = "QCmix", SampleID)) %>% summarise(mean(TIC))
blank_tic <- data_TIC %>% dplyr::filter(str_detect(pattern = "BLANK", SampleID)) %>% summarise(mean(TIC))
SRM_tic <- data_TIC %>% dplyr::filter(str_detect(pattern = "SRM", SampleID)) %>% summarise(mean(TIC))
ratio_tic_pb <- pool_tic/sample_tic
ratio_tic_sb <- sample_tic/blank_tic
ratio_tic_6p <- pool_tic/six_tic
# Check TIC overtime for QCpool, QCmix, Blank, SRM
data_TIC %>% dplyr::filter(str_detect(pattern = "Pool", SampleID)) %>%
ggscatter("Run_Order", "TIC", add = "reg.line") + ylim(0, 5.5e8) +
stat_cor()
data_TIC %>% dplyr::filter(str_detect(pattern = "QCmix", SampleID)) %>%
ggscatter("Run_Order", "TIC", add = "reg.line") + ylim(0, 5.5e8) +
stat_cor()
data_TIC %>% dplyr::filter(str_detect(pattern = "BLANK", SampleID)) %>%
ggscatter("Run_Order", "TIC", add = "reg.line") + ylim(0, 4.5e8) +
stat_cor()
data_TIC %>% dplyr::filter(str_detect(pattern = "SRM", SampleID)) %>%
ggscatter("Run_Order", "TIC", add = "reg.line") + ylim(0, 4.5e8) +
stat_cor()
# Check internal standard and remove sample where there was a shift
fbmn_IS <- annotations %>% dplyr::filter(str_detect(Compound_Name, regex("sulf", ignore_case = TRUE))) %>%
distinct(X.Scan., .keep_all = TRUE) %>% dplyr::filter(Organism != "BILELIB19")
# Extract IS features for the table
table_IS <- data %>% column_to_rownames("SampleID") %>% t() %>% as.data.frame() %>% rownames_to_column("ID") %>%
dplyr::filter(ID %in% fbmn_IS$X.Scan.) %>% column_to_rownames("ID") %>% t() %>% as.data.frame() %>%
rownames_to_column("SampleID") %>% dplyr::filter(!(str_detect(SampleID, "SRM|QCmix|Pool|BLANK|SRM|IS"))) %>%
dplyr::select(SampleID, `10746`) %>% left_join(metadata_metabolomics)
colnames(table_IS)[2] <- "Sulfadimethoxine"
table_IS %>% ggscatter(x = "Run_Order", y = "Sulfadimethoxine", add = c("reg.line")) + ylim(0, 4e6) +
stat_cor() # possibly discard samples with IS < 1,500,000 or IS > 2,500,000
table_IS %>% ggbarplot(x = "Run_Order", y = "Sulfadimethoxine", xlab = "Run Order",
ylab = "Peak Area Sulfadimethoxine", title = "Internal Standard Acquisition") +
geom_hline(yintercept = mean(table_IS$Sulfadimethoxine, na.rm = TRUE), linetype = "dashed", color = "blue")
cv_is <- sd(table_IS$Sulfadimethoxine)/mean(table_IS$Sulfadimethoxine)
# Check features in blanks and pools
data_blank <- data %>% dplyr::filter(str_detect(pattern = "BLANK", SampleID))
data_pools <- data %>% dplyr::filter(str_detect(pattern = "Pool", SampleID))
data_sixmix <- data %>% dplyr::filter(str_detect(pattern = "QCmix", SampleID))
data_srm <- data %>% dplyr::filter(str_detect(pattern = "SRM", SampleID))
# Blanks
blanks_feature_info <- data.frame(Feature = colnames(data_blank)[-1],
Mean_blank = data_blank %>% column_to_rownames("SampleID") %>% colMeans(),
SD_blank =  data_blank %>% column_to_rownames("SampleID") %>% apply(2, sd)) %>%
dplyr::mutate(CV_blank = SD_blank/Mean_blank) %>% left_join(annotations, by = c("Feature" = "X.Scan.")) %>%
left_join(info_feature) %>% dplyr::select(Feature, mz, RT, Compound_Name, SpectrumID,
Precursor_MZ, Mean_blank, SD_blank, CV_blank) %>%
dplyr::filter(Mean_blank > 0) %>% arrange(desc(Mean_blank))
# Six mix
sixmix_feature_info <- data.frame(Feature = colnames(data_sixmix)[-1],
Mean_sixmix = data_sixmix %>% column_to_rownames("SampleID") %>% colMeans(),
SD_sixmix = data_sixmix %>% column_to_rownames("SampleID") %>% apply(2, sd)) %>%
dplyr::mutate(CV_sixmix = SD_sixmix/Mean_sixmix) %>% left_join(annotations, by = c("Feature" = "X.Scan.")) %>%
left_join(info_feature) %>% dplyr::select(Feature, mz, RT, Compound_Name, SpectrumID,
Precursor_MZ, Mean_sixmix, SD_sixmix, CV_sixmix) %>%
dplyr::filter(Mean_sixmix > 0) %>% arrange(desc(Mean_sixmix))
# Pool
pools_feature_info <- data.frame(Feature = colnames(data_pools)[-1],
Mean_pool = data_pools %>% column_to_rownames("SampleID") %>% colMeans(),
SD_pool =  data_pools %>% column_to_rownames("SampleID") %>% apply(2, sd)) %>%
dplyr::mutate(CV_pool = SD_pool/Mean_pool) %>% left_join(annotations, by = c("Feature" = "X.Scan.")) %>%
left_join(info_feature) %>% dplyr::select(Feature, mz, RT, Compound_Name, SpectrumID,
Precursor_MZ, Mean_pool, SD_pool, CV_pool) %>%
dplyr::filter(Mean_pool > 0) %>% arrange(desc(Mean_pool))
# Features to be removed Pools/Blank < 5
feature_to_remove <- blanks_feature_info %>% left_join(pools_feature_info) %>%
dplyr::filter(Mean_blank > 0) %>%
dplyr::mutate(Pool_Blank = Mean_pool/Mean_blank) %>%
dplyr::filter(Pool_Blank < 5 | is.na(Pool_Blank))
# Data with blank removal
data_clean <- data %>% dplyr::select(-c(feature_to_remove$Feature)) %>%
dplyr::filter(!(SampleID %in% c("363132234", "363134035", "363192960", "363141305", "363193400"))) %>%
column_to_rownames("SampleID") %>%
select_if(~sum(.) != 0) %>% rownames_to_column("SampleID")
# Features to be removed Pool/QCmix < 5
feature_to_remove_mix <- sixmix_feature_info %>% left_join(pools_feature_info) %>%
dplyr::filter(Mean_sixmix > 0) %>%
dplyr::mutate(Pool_Mix = Mean_pool/Mean_sixmix) %>%
dplyr::filter(Pool_Mix < 5 | is.na(Pool_Mix)) %>%
dplyr::filter(!(Feature %in% feature_to_remove$Feature))
# Data with QCmix removal
data_clean2 <- data_clean %>% dplyr::select(-c(feature_to_remove_mix$Feature))
# Remove feature before 0.2 minutes and after 8 minutes
feature_to_remove_rt <- info_feature_complete %>% dplyr::filter(RT < 0.2 | RT > 8) %>%
dplyr::filter(!(Feature %in% feature_to_remove$Feature))  %>%
dplyr::filter(!(Feature %in% feature_to_remove_mix$Feature)) %>%
dplyr::filter(!(Feature %in% c("24265", "24508", "23576", "24312", "24394",
"24969", "25048", "24884", "23809")))
# Final cleaned table
data_clean3 <- data_clean2 %>% dplyr::select(-c(feature_to_remove_rt$Feature))
# Keep only samples
data_sample <- data_clean3 %>%
dplyr::filter(str_detect(pattern = "3631", SampleID))
# RCLR transformation
data_sample_clr <- decostand(data_sample %>% column_to_rownames("SampleID"), method = "rclr")
# Check sacrifice and longitudinal data separately
sample_sac <- metadata_metabolomics %>% dplyr::filter(study_type == "Sacrifice")
sample_long <- metadata_metabolomics %>% dplyr::filter(study_type != "Sacrifice")
sample_wt <- metadata_metabolomics %>% dplyr::filter(genotype == "3XTG")
sample_mut <- metadata_metabolomics %>% dplyr::filter(genotype == "B6")
sample_male <- metadata_metabolomics %>% dplyr::filter(sex == "male")
sample_female <- metadata_metabolomics %>% dplyr::filter(sex == "female")
##################
# SACRIFICE DATA #
##################
data_sacrifice <- data_sample %>%
dplyr::filter(SampleID %in% sample_sac$SampleID)
View(data_sacrifice)
